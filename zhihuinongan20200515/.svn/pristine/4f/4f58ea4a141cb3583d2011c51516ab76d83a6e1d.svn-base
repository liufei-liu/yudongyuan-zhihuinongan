<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1">
		<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="email=no">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<title>我的抽样</title>
		<meta name="keywords" content="">
		<meta name="Description" content="">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/public.css">
		<link rel="stylesheet" href="css/main.css">
		<script src="js/jquery.js"></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}

			/* * { touch-action: none; } */
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}

			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}

			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}

			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}

			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}

			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				margin: 0;
			}

			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}

			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}

			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}

			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}

			.mui-pull-top-canvas canvas {
				width: 40px;
			}

			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}

			#pullrefresh ul {}
		</style>

	</head>

	<body style="background-color: #F7F7F7;">
		<div class="header_box">
			<div class="header">
				<a class="back mui-action-back">
					<img src="images/back.png" alt="">
				</a>
				<h1>我的抽样</h1>
				<a class="home ">
					<img src="images/home.png" alt="" />
				</a>
			</div>
		</div>
		<!--添加抽样-->
		<div style="height: 1.12rem;">
			<div class="good_apply">
				<a href="tianjiachouyang.html">添加抽样</a>
			</div>
		</div>
		<!--记录生产列表-->
		<div id="pullrefresh">
			<ul class="sampling_list sampling_list_nopadding">

			</ul>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.pullToRefresh.js"></script>
		<script src="../js/mui.pullToRefresh.material.js"></script>
		<script src="js/init.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			mui.plusReady(function() {
				if (wainshow() == false) {
					return false;
				};
				var _self = plus.webview.currentWebview();
				var REGISTRATION_ID = _self.REGISTRATION_ID;
				var PRO_BATCH_NAME = _self.PRO_BATCH_NAME;
				var PRO_CATALOG_ID = _self.PRO_CATALOG_ID;
				var PRO_CAT1_ID = _self.PRO_CAT1_ID;
				// console.info(REGISTRATION_ID);
				(function($$) {
					$$.ready(function() { //定义参数
						var can_post = [true]; //是否可以发送数据
						var next = [0];
						//循环初始化所有下拉刷新，上拉加载。
						$$.each(document.querySelectorAll('#pullrefresh'), function(index, pullRefreshEl) {
							//加载数据方法
							var creatLi = function(url, index, self, reverse) {
								if (can_post[index]) {
									can_post[index] = false;
									$$.ajax(url, {
										data: {
											"EN_USER_ID": getState().en_user_id,
											"token": getToken(),
											"ENTERPRISE_ID": getState().enterprise_id,
											"REGISTRATION_ID": REGISTRATION_ID,
											"PAGE_NUM": next[index]++
										},
										type: 'post', //HTTP请求类型
										timeout: 10000, //超时时间设置为10秒；
										success: function(data) {
											check_ajax(data, function(data) {
												if (data == "") {
													can_post[index] = false;
													self.endPullUpToRefresh(true);
												} else {
													for (var i = 0, str = ""; i < data.length; i++) {
														let status;
														if (data[i].status == "0") {
															status = "待上传";
														} else if (data[i].status == "1") {
															status = "待检测";
														} else if (data[i].status == "2") {
															status = "已检测";
														}

														if (data[i].status == "0") {
															str += ' <li class="sampling_product" value="' + data[i].sample_id + '">' +
																'<div>' +
																'<button class="Upload">上传</button>' +
																'<button class="delete">删除</button>' +
																'</div>' +
																'<a href="" data-extras=\'{"pro_batch_name":"' + data[i].pro_batch_name +
																'","registration_id":"' + data[i].registration_id + '","pro_cat1_id":"' + data[i].pro_cat1_id +
																'","pro_catalog_id":"' + data[i].pro_catalog_id + '"}\'>' +
																'<img src="' + www + data[i].img_url + '" alt=""/>' +
																'<div>' +
																'<p>批次名称：<span>' + data[i].pro_batch_name + '</span></p>' +
																'<p>产品名称：<span>' + data[i].product_name + '</span></p>' +
																'<p>采样人员：<span>' + data[i].sample_operator + '</span></p>' +
																'<p>状态：<span>' + status + '</span></p>' +

																'<b>' + data[i].create_time + '</b>' +
																'</div>' +
																'</a>' +
																'</li>';
														} else {
															str += ' <li class="sampling_product">' +

																'<a href="" data-extras=\'{"pro_batch_name":"' + data[i].pro_batch_name +
																'","registration_id":"' + data[i].registration_id + '","pro_cat1_id":"' + data[i].pro_cat1_id +
																'","pro_catalog_id":"' + data[i].pro_catalog_id + '"}\'>' +
																'<img src="' + www + data[i].img_url + '" alt=""/>' +
																'<div>' +
																'<p>批次名称：<span>' + data[i].pro_batch_name + '</span></p>' +
																'<p>产品名称：<span>' + data[i].product_name + '</span></p>' +
																'<p>采样人员：<span>' + data[i].sample_operator + '</span></p>' +
																'<p>状态：<span>' + status + '</span></p>' +

																'<b>' + data[i].create_time + '</b>' +
																'</div>' +
																'</a>' +
																'</li>';
														}
													}
													var ul = self.element.querySelector('.sampling_list');
													$(ul).append(str);
													self.endPullUpToRefresh(); //参数为true代表没有更多数据了。
													$$.toast('刷新成功', {
														duration: '100',
														type: 'div'
													})

													if (reverse) {
														data.reverse();
													}
												}
											})
										},
										error: function(xhr, type, errorThrown, selfs) {
											setTimeout(function() {

												self.endPullUpToRefresh(false);

											}, 500)
											if (type == "timeout") {
												alert("请求超时");
											} else if (type == "abort") {
												alert("请检查您的网络");
											} else if (type == "error") {
												alert("服务端错误");
											}
										}
									});
								} else {

									self.endPullUpToRefresh(true);

								}
							}
							//上拉加载
							var upAjax = function() {
								var self = this;
								creatLi(www_v + "/sample/sample_list", index, self);
							}
							//下拉加载
							// var downAjax = function() {
							// 	var self = this;
							// 	//creatLi(www_v+"/quality/registrationlist", index, self, true);
							// 	location.reload();
							// }
							$$(pullRefreshEl).pullToRefresh({
								down: {
									//callback: downAjax
								},
								up: {
									callback: upAjax
								}
							});
						});
						 mui("#pullrefresh").pullToRefresh().pullUpLoading();
					});
				})(mui);

				window.addEventListener('listenerWorkState', function(e) {
					location.reload();
				});

				//传数据
				mui('body').on('tap', '.good_apply a', function() {
					if (unsafe_tap2()) return; // 调用代码
					var id = this.getAttribute("data-wid");
					if (!id) {
						id = this.getAttribute('href');
					}
					var old_id = plus.webview.getWebviewById(id);
					if (old_id) {
						old_id.close("none", 0);
					}
					var href = this.getAttribute('href');
					var webview_style = {
						popGesture: "hide "
					}
					var extras = {
						"REGISTRATION_ID": REGISTRATION_ID,
						"PRO_BATCH_NAME": PRO_BATCH_NAME,
						"PRO_CATALOG_ID": PRO_CATALOG_ID,
						"PRO_CAT1_ID": PRO_CAT1_ID
					};
					var webview = plus.webview.create(this.href, id, webview_style, extras);
					webview.addEventListener("titleUpdate", function() {
						setTimeout(function() {
							webview.show('pop-in', 300);
						}, 100);
					});
				});
				//删除
				$('.sampling_list').on('tap', '.delete', function() {
					var val = $(this).parents("li").attr("value");
					console.info("删除1");
					var btnArray = ['否', '是'];
					mui.confirm('确认要删除？', TITLE, btnArray, function(e) {
						if (e.index == 1) {
							mui.ajax(www_v + "/sample/delete_sample", {
								data: {
									"token": getToken(),
									"SAMPLE_ID": val
								},
								type: 'post', //HTTP请求类型
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									check_ajax(data, function(data) {
										plus.nativeUI.toast("已删除");
										location.reload();
									})
								},
								error: function(xhr, type, errorThrown, selfs) {
									if (type == "timeout") {
										alert("请求超时");
									} else if (type == "abort") {
										alert("请检查您的网络");
									} else if (type == "error") {
										alert("服务端错误");
									}
								}
							});
						}
					})
				});
				//提交
				$('.sampling_list').on('tap', '.Upload', function() {
					var val = $(this).parents("li").attr("value");
					console.info("提交");
					var btnArray = ['否', '是'];
					mui.confirm('确认要上传？', TITLE, btnArray, function(e) {
						if (e.index == 1) {
							mui.ajax(www_v + "/sample/upload_sample", {
								data: {
									"token": getToken(),
									"SAMPLE_ID": val
								},
								type: 'post', //HTTP请求类型
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									check_ajax(data, function(data) {
										plus.nativeUI.toast("已上传");
										location.reload();
									})
								},
								error: function(xhr, type, errorThrown, selfs) {
									if (type == "timeout") {
										alert("请求超时");
									} else if (type == "abort") {
										alert("请检查您的网络");
									} else if (type == "error") {
										alert("服务端错误");
									}
								}
							});
						}
					})
				});
			})
		</script>
	</body>

</html>
