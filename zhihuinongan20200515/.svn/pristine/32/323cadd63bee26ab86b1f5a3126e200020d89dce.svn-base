<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1">
		<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="email=no">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<title>无害化处理</title>
		<meta name="keywords" content="">
		<meta name="Description" content="">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../app/css/style.css">
		<link rel="stylesheet" href="../app/css/public.css">
		<link rel="stylesheet" href="../app/css/main.css">
		<script src="../app/js/jquery.js"></script>
			<style type="text/css">
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 9999999;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100%;
				height: auto;
			}
		</style>
	</head>

	<body style="background-color:#fff;">
		<div class="header_box">
			<div class="header">
				<a class="back mui-action-back">
					<img src="../app/images/back.png" alt="">
				</a>
				<h1>无害化处理</h1>
				<a class="home ">
					<img src="../app/images/home.png" alt="" />
				</a>
			</div>
		</div>		
		<form id="form_info" action="" method="post" class="register_list register_list_long">
			<input type="hidden" name="SUPPLY_TYPE" value="1"/>
			<input type="hidden" name="IMG_ID"/>
			<input type="hidden" name="token"/>
			<input type="hidden" name="EN_USER_ID"/>
			<input type="hidden" name="SUPPLY_CATALOG_ID"/>
			<input type="hidden" name="RECORD_CATALOG" value="5"/>
			<input type="hidden" name="ENTERPRISE_ID" value=""/>

			<ul>
				<li>
					<span>产&nbsp;品&nbsp;名&nbsp;称&nbsp;：</span>
					<div>
						<input type="text" name="SUPPLY_CATALOG_NAME" readonly value="" />
						<div>
							<span class=""></span>
						</div>
					</div>
				</li>
				<li>
					<span>处&nbsp;理&nbsp;批&nbsp;次&nbsp;：</span>
					<div>
						<input type="text" name="SUPPLY_BATCH_NAME" readonly value="" />
						<div>
							<span class=""></span>
						</div>
					</div>
				</li>
				<li>
					<span>进&nbsp;货&nbsp;批&nbsp;次&nbsp;：</span>
					<a href="wuhaihuachuli_jinhuopici.html" data-wid="wuhaihuachuli_jinhuopici.html" data-spec="ture" id="wuhaihuachuli_jinhuopici" data-extras='{"SUPPLY_TYPE":"3"}'>
						<input type="text" name="UPPER_SUPPLY_ID_SHOW" readonly value="" placeholder="请选择进货批次"/>
						<input type="hidden" name="UPPER_SUPPLY_ID"value=""/>
						<div>
							<span class="input_tip_more"></span>
						</div>
					</a>
				</li>
				<li class="list_short">
					<span>数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：</span>
					<div>
						<input type="number" name="INPUT_AMOUNT" value="" placeholder="请输入数量" min="0.0" step="0.01"/>
						<div id="size">
							<span class="input_tip_more"></span>
							<b>袋</b>
							<input type="hidden" name='INPUT_AMOUNT_UNIT' value="袋"/>
						</div>
						
					</div>
				</li>
				<li>
					<span id="change_num_name">登&nbsp;记&nbsp;证&nbsp;号&nbsp;：</span>
					<div>
						<input type="text" name="REG_NUM" placeholder="请输入登记证号"/>
						<div>
							<span></span>
						</div>
					</div>
				</li>
				<li>
					<span>处&nbsp;理&nbsp;方&nbsp;法：</span>
					<div id="func">
						<input type="text" name="PROCESS_METHOD" placeholder="请选择处理方法"/>
						<div>
							<span class="input_tip_more"></span>
						</div>
					</div>
				</li>
				<li>
					<span>处&nbsp;理&nbsp;原&nbsp;因&nbsp;：</span>
					<div>
						<input type="text" name="PROCESS_REASON" placeholder="请输入处理原因"/>
						<div>
							<span></span>
						</div>
					</div>
				</li>
				<li>
					<span>操&nbsp;&nbsp;&nbsp;&nbsp;作&nbsp;&nbsp;&nbsp;&nbsp;人：</span>
					<div>
						<input type="text" name="RECORD_OPERATOR" placeholder="请输入购买人名称"/>
						<div>
							<span></span>
						</div>
					</div>
				</li>
				<li>
					<span>备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</span>
					<div>
						<input type="text" name="SUPPLY_REMARKS" placeholder="请输入备注信息" />
						<div>
							<span></span>
						</div>
					</div>
				</li>
			</ul>
			<div id="img_box">
				<p>上传图片（处理现场图片）：</p>
				<ul>
					<li id="add_img">
						<img src="../app/images/add.png" alt="" />
					</li>
				</ul>
				<p class="img_tip">注：长按图片可以进行删除</p>
			</div>
			<div class="submit_btn_box">
				<button class="bozhong_submit">保存</button>
			</div>
		</form>
		<ul class="record_list" style="border-top: 0.15rem solid #efeff4;">
				<!--<li>
					<a href="shengchanliucheng.html" data-extras='{"name":"123","batch":"123"}'>
						<img src="images/ceshi/1.jpg" alt="" />
						<div>
							<p>批次名称：<span>草莓2017120201 </span></p>
							<p>产品名称：<span>绿色草莓</span></p>
							<b>2017-08-11</b>
						</div>
					</a>
				</li>
				<li>
					<a href="shengchanliucheng.html" data-extras='{"name":"123","batch":"123"}'>
						<img src="images/ceshi/1.jpg" alt="" />
						<div>
							<p>批次名称：<span>草莓2017120201 </span></p>
							<p>产品名称：<span>绿色草莓</span></p>
							<b>2017-08-11</b>
						</div>
					</a>
				</li>-->
			</ul>
		<script src="../js/mui.min.js"></script>
		<script src="../app/js/jquery.form.min.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../app/js/init.js"></script>
		<script src="../app/js/public.js"></script>

		<script>
			mui.init({
			  gestureConfig:{
			    longtap: true, //默认为false
			    release:true
			  }
			});
			mui.plusReady(function(){
				/*提交表单的返回*/
				var can_back=true;
				$("body").on("keyup",function(){
					can_back=false;
				})
			 	var old_back=mui.back;
				mui.back=function(){
					if(can_back){
						old_back();
					}else{
						var btnArray = ['否', '是'];
		                mui.confirm('确认要返回么，确认？', TITLE, btnArray, function(e) {
		                    if (e.index == 1) {
		                        old_back();
		                    }
		                })
					}	
				}
				mui.previewImage();
				var _self = plus.webview.currentWebview();
					var OPTION_ID = _self.OPTION_ID;
					var OPTION_NAME = _self.OPTION_NAME;
					var OPTION_TYPE=_self.OPTION_TYPE;
					switch(OPTION_TYPE){
						case "1":
							//肥料
							$("#change_num_name").html("登&nbsp;记&nbsp;证&nbsp;号&nbsp;：");
							$("input[name='REG_NUM']").attr("placeholder","请输入登记证号");
							var bts = [{
								title: "袋",
								name:'d'
							}, {
								title: "千克",
								name:'kg'
							}];
						break;
						case "2":
							//农药
							$("#change_num_name").html("登&nbsp;记&nbsp;证&nbsp;号&nbsp;：");
							$("input[name='REG_NUM']").attr("placeholder","请输入登记证号");
							var bts = [{
								title: "袋",
								name:'d'
							}, {
								title: "瓶",
								name:'p'
							}];
						break;
						case "4":
							//种子
							$("#change_num_name").html("经营许可证：");
							$("input[name='REG_NUM']").attr("placeholder","请输入经营许可证");
							var bts = [{
								title: "袋",
								name:'d'
							}, {
								title: "千克",
								name:'kg'
							}];
						break;
					}

				$("input[name='SUPPLY_CATALOG_ID']").val(OPTION_ID);
				$("input[name='token']").val(getToken());
				$("input[name='SUPPLY_CATALOG_NAME']").val(OPTION_NAME);
				$("input[name='EN_USER_ID']").val(getState().en_user_id);
				$("input[name='ENTERPRISE_ID']").val(getState().enterprise_id);
				$("input[name='SUPPLY_BATCH_NAME']").val(OPTION_NAME+getNowFormatDate(false));
				window.addEventListener('refresh_recode_name', function(e) {
					var vals=e.detail;
					//console.log(JSON.stringify(vals));
					$("input[name='UPPER_SUPPLY_ID']").val(vals._id);
					$("input[name='UPPER_SUPPLY_ID_SHOW']").val(vals._html);
					
					$("input[name='REG_NUM']").val(vals.REG_NUM);
//					$("input[name='PRODUCTION_DATE']").val(vals.PRODUCTION_DATE.slice(0,10));
//					$("input[name='PRO_UNIT']").val(vals.PRO_UNIT);
					
					$("#size>b").html(vals.INPUT_AMOUNT_UNIT);
					$("input[name='INPUT_AMOUNT_UNIT']").val(vals.INPUT_AMOUNT_UNIT);
					$("#size").addClass("disabled").children("span").removeClass();
					$("input[name='INPUT_AMOUNT']").val("");
//					.attr("placeholder","最大为"+vals.INPUT_AMOUNT);
//					$("input[name='INPUT_AMOUNT']").on("blur",function(){
//						var val=$(this).val();
//						if(val<0){
//							plus.nativeUI.toast("请输入不小于0的数");
//							$("input[name='INPUT_AMOUNT']").focus();
//						}else if(val>vals.INPUT_AMOUNT){
//							plus.nativeUI.toast("请输入不大于"+vals.INPUT_AMOUNT+"的数");
//							$("input[name='INPUT_AMOUNT']").focus();
//						}
//						
//					})
				})

				
				document.getElementById("size").addEventListener('tap', function() {
					if($(this).hasClass("disabled")){
						return false;
					}
					var self=this;
					
					plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: bts
					}, function(e) {
						var i = e.index;
						if(i > 0) {
							var title=bts[i - 1].title;
							$(self).children('b').html(title);
							$("input[name='INPUT_AMOUNT_UNIT']").val(title);
						}
					});
				});
				document.getElementById("func").addEventListener('tap', function() {
					var self=this;
					var bts = [{
						title: "厂家回收",
						name:'c1'
					}];
					plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: bts
					}, function(e) {
						var i = e.index;
						if(i > 0) {
							var title=bts[i - 1].title;
							$("input[name='PROCESS_METHOD']").val(title);
						}
					});
				});
				
				mui("#img_box").on('longtap','ul li',function(){
					var _this=this;
					if(_this.id!="add_img"){
						var btnArray = ['否', '是'];
		                mui.confirm('确认要删除该图片么，确认？', TITLE, btnArray, function(e) {
		                    if (e.index == 1) {
							 	if(wainshow()==false){return false;};
								$.ajax(www_v+"/img/pro_img_delete/", {
									data: {"token":getToken(),"IMG_ID":$(_this).attr("value")},
									type: 'post', //HTTP请求类型
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
										check_ajax(data,function(data){
										 	var d_val=$(_this).attr("value");
										 	var old_val=$("input[name='IMG_ID']").val();
										 	var new_val=old_val.replace(d_val,'');
										 	new_val=new_val.replace(',,',',');
										 	if(new_val.slice(0,1)==","){
										 		new_val=new_val.slice(1);
										 	}
										 	if(new_val.slice(-1)==","){
										 		new_val=new_val.slice(0,-1);
										 	}
										 	$("input[name='IMG_ID']").val(new_val);
										 	$(_this).remove();
											plus.nativeUI.toast('删除成功');
										})
									},
									error: function(xhr, type, errorThrown, selfs) {
										if(type == "timeout") {
											alert("请求超时");
										} else if(type == "abort") {
											alert("请检查您的网络");
										} else if(type == "error") {
											alert("服务端错误");
										}
									}
								});
							}
		                })
				 	}
				})
				document.getElementById("add_img").addEventListener('tap', function() {
						var self=this;
						var caremaorimg = [{
							title: "拍照",
							name:"p"
						}, {
							title: "相册",
							name:"x"
						}];
						plus.nativeUI.actionSheet({
							cancel: "取消",
							buttons: caremaorimg
						}, function(e) {
							var i = e.index;
							var _callback=function(data){
										check_ajax(data,function(data){
									 	var val=$("input[name='IMG_ID']").val();
									 	if(val==""||val==undefined){
									 		$("input[name='IMG_ID']").val(data.IMG_ID);	
									 	}else{
									 		$("input[name='IMG_ID']").val(val+","+data.IMG_ID);	
									 	}
									 	//console.log($("input[name='IMG_ID']").val());
									 	//console.log(data.IMG_URL);
									 	var imgs=data.IMG_URL.split(",");
									 	var ids=data.IMG_ID.split(",");
									 	for(var i=0,str="";i<imgs.length;i++){
									 		str+='<li value="'+ids[i]+'"><img src="'+www+imgs[i]+'" alt="" data-preview-src="" data-preview-group="1"/></li>'
									 	}
									 	$("#img_box>ul").append(str);
										})
							}
							if(i > 0) {
								switch(i){
									 case 1:p(www_v+"/img/prod_img",_callback,"3");
									 break;
									 case 2:x(www_v+"/img/prod_img",_callback,"3");
									 break;
								}
							}
						});
					});
					var options={
					url:www_v+"/arg_store/add_argproduct/",
					beforeSubmit:function(){
						if(wainshow()==false){return false;}; 
						if(unsafe_tap2()) return false; // 调用代码
//						if($("input[name='IMG_ID']").val().trim()==""){
//							plus.nativeUI.toast("请上传图片");
//							return false;
//						}
					},
					success:function(data){
						//console.log(data);
						check_ajax(data,function(data){
							//console.log(JSON.stringify(data));
							plus.nativeUI.toast("添加成功");
								var webview_style = {
									popGesture: "hide "
								}
								var extras = {};
								var href = "wuhaihuachuli.html";
								var id = "wuhaihuachuli.html";
								var old_id=plus.webview.getWebviewById(id);
								if(old_id){
									old_id.close("none",0);
								}
								var webview = plus.webview.create(href, id, webview_style, extras);
								webview.addEventListener("titleUpdate", function() {
									setTimeout(function() {
										webview.show('pop-in', 300);
									}, 100);
								});
								setTimeout(function() {
									 plus.webview.currentWebview().close("none",0);  
								}, 500);
						})
						
					},error:function(e){
						alert("服务端错误");
					}
				};
				$("#form_info").ajaxForm(options);
				
				mui("body").on("tap","#wuhaihuachuli_jinhuopici",function(){
					if(unsafe_tap2()) return; // 调用代码
					var id = this.getAttribute("data-wid");
					if(!id) {
						id = this.getAttribute('href');
					}
					var old_id=plus.webview.getWebviewById(id);
					if(old_id){
						old_id.close("none",0);
					}
					var href = this.getAttribute('href');
					var extras = {"SUPPLY_TYPE":OPTION_TYPE,"SUPPLY_CATALOG_ID":OPTION_ID};
					var webview_style = {
						popGesture: "hide"
					}
					var webview = plus.webview.create(this.href, id, webview_style, extras);
					webview.addEventListener("titleUpdate", function() {
						setTimeout(function() {
							webview.show('pop-in', 300);
						}, 100);
					});
				})
				
				
			})
		</script>
	</body>

</html>